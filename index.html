<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YAKUtime 受付機</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f8faff; font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 20px 50px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-[40px] p-10 card-shadow relative overflow-hidden">
        <!-- 背景の装飾 -->
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>

        <header class="text-center mb-10">
            <h1 class="text-4xl font-black text-slate-800 mb-2">YAKUtime <span class="text-blue-600 text-2xl">PRO</span></h1>
            <p id="display-shop-name" class="text-slate-400 font-bold tracking-widest uppercase text-sm">SHOP: LOADING...</p>
        </header>

        <div class="text-center space-y-8">
            <div>
                <p class="text-slate-400 font-bold mb-4">現在の待ち組数</p>
                <div id="wait-count" class="text-[120px] font-black text-slate-800 leading-none">0</div>
            </div>

            <div class="pt-6">
                <button id="btn-reception" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-3xl font-black py-10 rounded-[30px] shadow-2xl shadow-indigo-200 active:scale-95 transition-all">
                    受付をする
                </button>
                <p class="text-slate-400 text-xs mt-6 font-medium leading-relaxed">
                    ※待ち組数・時間は目安であり調剤内容・予約等で前後する場合があります。
                </p>
            </div>
        </div>

        <!-- スタッフ用操作パネル (隠し要素) -->
        <div class="mt-12 pt-8 border-t border-slate-50 flex justify-center gap-4">
            <button id="btn-minus" class="w-12 h-12 rounded-full border border-slate-100 flex items-center justify-center text-slate-300 hover:text-red-500 transition-colors">
                <i data-lucide="minus"></i>
            </button>
            <button id="btn-plus" class="w-12 h-12 rounded-full border border-slate-100 flex items-center justify-center text-slate-300 hover:text-green-500 transition-colors">
                <i data-lucide="plus"></i>
            </button>
        </div>
        <p class="text-center text-[10px] text-slate-300 mt-2 font-bold tracking-widest uppercase">Staff Only</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjSZkIuGQ4oRoMcZYLaZbdBXK45cBBXos",
            authDomain: "yakutime-for-ipad.firebaseapp.com",
            projectId: "yakutime-for-ipad",
            storageBucket: "yakutime-for-ipad.firebasestorage.app",
            messagingSenderId: "732724570588",
            appId: "1:732724570588:web:6e64cba96c6fd17646c719"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'yakutime-for-ipad';

        // URLからshopIdを取得 (例: ?shopId=shibuya-001)
        const urlParams = new URLSearchParams(window.location.search);
        const shopId = urlParams.get('shopId') || 'shibuya-001'; // 指定がない場合はデフォルト

        lucide.createIcons();

        async function init() {
            await signInAnonymously(auth);
            
            // 修正されたパスでドキュメントを参照
            const shopRef = doc(db, 'artifacts', appId, 'public', 'data', 'shops', shopId);

            // リアルタイム更新の監視
            onSnapshot(shopRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('wait-count').innerText = data.status?.waiting?.count || 0;
                    document.getElementById('display-shop-name').innerText = `SHOP: ${data.name || shopId}`;
                } else {
                    document.getElementById('display-shop-name').innerText = "店舗が見つかりません";
                }
            });

            // 更新関数
            const updateCount = async (val) => {
                try {
                    await updateDoc(shopRef, {
                        "status.waiting.count": increment(val),
                        "status.waiting.updatedAt": serverTimestamp()
                    });
                } catch (e) { console.error(e); }
            };

            document.getElementById('btn-reception').onclick = () => updateCount(1);
            document.getElementById('btn-plus').onclick = () => updateCount(1);
            document.getElementById('btn-minus').onclick = () => updateCount(-1);
        }

        init();
    </script>
</body>
</html>
