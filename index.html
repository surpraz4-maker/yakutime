<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAKUtime Reception PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QRコード生成ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            background: radial-gradient(circle at top right, #f8faff, #eef2ff);
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            overflow: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-press {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-press:active {
            transform: scale(0.92);
        }
        .waiting-number {
            font-variant-numeric: tabular-nums;
            text-shadow: 0 10px 20px rgba(30, 41, 59, 0.1);
        }
        /* モーダル表示のアニメーション */
        .modal-enter { animation: modalFadeIn 0.3s ease-out forwards; }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="max-w-md w-full glass-card rounded-[3rem] shadow-2xl p-10 text-center relative overflow-hidden border-t-8 border-indigo-600">
        
        <!-- ヘッダー -->
        <div class="mb-12">
            <h1 class="text-4xl font-black text-slate-800 tracking-tighter mb-2">
                YAKUtime <span class="text-indigo-600">PRO</span>
            </h1>
            <p id="shop-name" class="text-slate-400 font-bold tracking-widest text-sm uppercase">SHOP: 読み込み中...</p>
        </div>

        <!-- メインコンテンツ -->
        <div class="space-y-8 relative z-10">
            <div>
                <p class="text-slate-400 font-bold mb-4">現在の待ち組数</p>
                <div id="display-count" class="waiting-number text-[10rem] font-black text-slate-800 leading-none">
                    0
                </div>
            </div>

            <button id="btn-reception" class="w-full py-8 bg-indigo-600 text-white rounded-[2rem] text-3xl font-black shadow-xl shadow-indigo-200 btn-press hover:bg-indigo-700">
                受付をする
            </button>

            <p class="text-slate-400 text-xs leading-relaxed font-medium">
                ※待ち組数・時間は目安であり調剤内容・予約等で前後する場合があります。
            </p>
        </div>

        <!-- スタッフ用隠し操作 -->
        <div class="mt-16 pt-8 border-t border-slate-100">
            <div class="flex items-center justify-center gap-6">
                <button id="btn-minus" class="w-14 h-14 flex items-center justify-center rounded-full border-2 border-slate-100 text-slate-200 hover:text-indigo-400 hover:border-indigo-200 transition-colors btn-press">
                    <i data-lucide="minus" class="w-8 h-8"></i>
                </button>
                <button id="btn-plus" class="w-14 h-14 flex items-center justify-center rounded-full border-2 border-slate-100 text-slate-200 hover:text-indigo-400 hover:border-indigo-200 transition-colors btn-press">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
            </div>
            <p class="text-[10px] text-slate-300 font-black mt-4 tracking-widest uppercase">Staff Only</p>
        </div>

        <!-- QRコードオーバーレイ (初期は非表示) -->
        <div id="qr-overlay" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 hidden">
            <div class="modal-enter flex flex-col items-center">
                <div class="bg-emerald-100 text-emerald-600 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="check" class="w-10 h-10"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800 mb-2">受付完了</h2>
                <p class="text-slate-500 text-sm mb-6">スマホで外から待ち状況を確認できます</p>
                
                <div id="qrcode-container" class="p-4 bg-white border-4 border-slate-50 rounded-2xl mb-8"></div>
                
                <p class="text-indigo-600 font-bold animate-pulse text-sm">QRを読み取ってお進みください</p>
                
                <button id="btn-close-qr" class="mt-8 text-slate-300 font-bold text-xs uppercase tracking-widest">閉じる</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, serverTimestamp, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjSZkIuGQ4oRoMcZYLaZbdBXK45cBBXos",
            authDomain: "yakutime-for-ipad.firebaseapp.com",
            projectId: "yakutime-for-ipad",
            storageBucket: "yakutime-for-ipad.firebasestorage.app",
            messagingSenderId: "732724570588",
            appId: "1:732724570588:web:6e64cba96c6fd17646c719"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'yakutime-for-ipad';
        const urlParams = new URLSearchParams(window.location.search);
        const shopId = urlParams.get('shopId') || 'shibuya-001';

        let currentCount = 0;

        lucide.createIcons();

        async function init() {
            await signInAnonymously(auth);
            const shopRef = doc(db, 'artifacts', appId, 'public', 'data', 'shops', shopId);
            const logColRef = collection(db, 'artifacts', appId, 'public', 'data', 'shops', shopId, 'logs');

            onSnapshot(shopRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    currentCount = data.status?.waiting?.count || 0;
                    document.getElementById('display-count').innerText = currentCount;
                    document.getElementById('shop-name').innerText = `SHOP: ${data.name || shopId}`;
                }
            });

            // 受付実行
            document.getElementById('btn-reception').onclick = async () => {
                // 1. データ更新
                await updateDoc(shopRef, {
                    "status.waiting.count": increment(1),
                    "status.waiting.totalToday": increment(1)
                });
                await addDoc(logColRef, {
                    type: 'reception',
                    timestamp: serverTimestamp(),
                    completedAt: null
                });

                // 2. QRコード生成（患者が自分のスマホで見るためのURL）
                // GitHub PagesのURLを動的に生成
                const baseUrl = window.location.href.split('reception.html')[0];
                const patientUrl = `${baseUrl}index.html?shopId=${shopId}`;
                
                const qrContainer = document.getElementById('qrcode-container');
                qrContainer.innerHTML = ""; // クリア
                new QRCode(qrContainer, {
                    text: patientUrl,
                    width: 180,
                    height: 180,
                    colorDark : "#1e293b",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                // 3. 表示
                const overlay = document.getElementById('qr-overlay');
                overlay.classList.remove('hidden');

                // 4. 10秒後に自動で閉じる
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 10000);
            };

            document.getElementById('btn-close-qr').onclick = () => {
                document.getElementById('qr-overlay').classList.add('hidden');
            };

            document.getElementById('btn-plus').onclick = () => {
                updateDoc(shopRef, { "status.waiting.count": increment(1) });
            };

            document.getElementById('btn-minus').onclick = () => {
                if (currentCount > 0) {
                    updateDoc(shopRef, { "status.waiting.count": increment(-1) });
                }
            };
        }

        init();
    </script>
</body>
</html>
