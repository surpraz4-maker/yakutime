<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YAKUtime 受付機</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f0f4f8; font-family: 'Helvetica Neue', Arial, sans-serif; }
        .btn-shadow { box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); }
        .complete-shadow { box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4); }
    </style>
</head>
<body class="h-screen flex items-center justify-center p-6">

    <div class="bg-white w-full max-w-lg rounded-[3rem] shadow-2xl p-10 flex flex-col items-center relative overflow-hidden">
        <!-- 背景の装飾 -->
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-right from-blue-500 to-indigo-600"></div>

        <!-- ヘッダー -->
        <div class="mb-10 text-center">
            <h1 class="text-4xl font-black text-blue-700 mb-2">YAKUtime <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded-lg text-xl align-middle">PRO</span></h1>
            <p id="shop-name-display" class="text-gray-400 font-bold uppercase tracking-widest text-sm">LOADING...</p>
        </div>

        <!-- 待ち人数表示 -->
        <div class="text-center mb-10">
            <p class="text-gray-400 font-bold mb-4">現在の待ち組数</p>
            <div id="count-display" class="text-[120px] font-black text-slate-800 leading-none mb-4">0</div>
            <p id="next-number" class="text-blue-600 font-bold text-xl">次にお呼びする番号: <span class="text-2xl">1</span> 番</p>
        </div>

        <!-- メインアクション -->
        <button id="btn-reception" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-8 rounded-[2rem] text-3xl font-black btn-shadow active:scale-95 transition-all mb-8 flex items-center justify-center gap-4">
            <i data-lucide="user-plus" class="w-10 h-10"></i>
            受付をする
        </button>

        <p class="text-gray-400 text-sm mb-12 text-center leading-relaxed px-6">
            ※待ち組数・時間は目安であり調剤内容・予約等で前後する場合があります。
        </p>

        <!-- 管理用ボタン -->
        <div class="w-full border-t border-gray-100 pt-10 flex flex-col items-center">
            <button id="btn-complete" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-5 rounded-2xl text-xl font-black complete-shadow active:scale-95 transition-all mb-4">
                完了
            </button>
            <p class="text-gray-300 text-[10px] font-bold uppercase tracking-tighter">※スタッフ専用（管理者用）</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjSZkIuGQ4oRoMcZYLaZbdBXK45cBBXos",
            authDomain: "yakutime-for-ipad.firebaseapp.com",
            projectId: "yakutime-for-ipad",
            storageBucket: "yakutime-for-ipad.firebasestorage.app",
            messagingSenderId: "732724570588",
            appId: "1:732724570588:web:6e64cba96c6fd17646c719"
        };

        const appId = 'yakutime-for-ipad';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // 管理画面（Pro）と共通の店舗IDを使用
        // 本来はURL引数などで指定可能にする（?shopId=shibuya-001）
        const urlParams = new URLSearchParams(window.location.search);
        const currentShopId = urlParams.get('shopId') || localStorage.getItem('yakutime_shop_id') || 'shibuya-001';
        
        let currentCount = 0;

        lucide.createIcons();

        async function init() {
            await signInAnonymously(auth);
            
            const shopRef = doc(db, 'artifacts', appId, 'public', 'data', 'shops', currentShopId);
            
            // リアルタイム同期
            onSnapshot(shopRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    currentCount = data.status?.waiting?.count || 0;
                    document.getElementById('count-display').innerText = currentCount;
                    document.getElementById('shop-name-display').innerText = data.name || currentShopId;
                    document.getElementById('next-number').querySelector('span').innerText = currentCount + 1;
                }
            });

            // 受付ボタン：カウントを＋１
            document.getElementById('btn-reception').onclick = async () => {
                await updateDoc(shopRef, {
                    "status.waiting.count": currentCount + 1,
                    "status.waiting.updatedAt": serverTimestamp()
                });
            };

            // 完了ボタン：カウントをー１（スタッフが呼び出して対応完了した時）
            document.getElementById('btn-complete').onclick = async () => {
                if (currentCount > 0) {
                    await updateDoc(shopRef, {
                        "status.waiting.count": currentCount - 1,
                        "status.waiting.updatedAt": serverTimestamp()
                    });
                }
            };
        }

        window.onload = init;
    </script>
</body>
</html>
