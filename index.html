<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAKUtime Reception PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: radial-gradient(circle at top right, #f8faff, #eef2ff);
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-press {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-press:active {
            transform: scale(0.92);
        }
        .waiting-number {
            font-variant-numeric: tabular-nums;
            text-shadow: 0 10px 20px rgba(30, 41, 59, 0.1);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="max-w-md w-full glass-card rounded-[3rem] shadow-2xl p-10 text-center relative overflow-hidden border-t-8 border-indigo-600">
        
        <!-- ヘッダー -->
        <div class="mb-12">
            <h1 class="text-4xl font-black text-slate-800 tracking-tighter mb-2">
                YAKUtime <span class="text-indigo-600">PRO</span>
            </h1>
            <p id="shop-name" class="text-slate-400 font-bold tracking-widest text-sm uppercase">SHOP: 読み込み中...</p>
        </div>

        <!-- メインコンテンツ -->
        <div class="space-y-8 relative z-10">
            <div>
                <p class="text-slate-400 font-bold mb-4">現在の待ち組数</p>
                <div id="display-count" class="waiting-number text-[10rem] font-black text-slate-800 leading-none">
                    0
                </div>
            </div>

            <button id="btn-reception" class="w-full py-8 bg-indigo-600 text-white rounded-[2rem] text-3xl font-black shadow-xl shadow-indigo-200 btn-press hover:bg-indigo-700">
                受付をする
            </button>

            <p class="text-slate-400 text-xs leading-relaxed font-medium">
                ※待ち組数・時間は目安であり調剤内容・予約等で前後する場合があります。
            </p>
        </div>

        <!-- スタッフ用隠し操作 (マイナス制御付き) -->
        <div class="mt-16 pt-8 border-t border-slate-100">
            <div class="flex items-center justify-center gap-6">
                <button id="btn-minus" class="w-14 h-14 flex items-center justify-center rounded-full border-2 border-slate-100 text-slate-200 hover:text-indigo-400 hover:border-indigo-200 transition-colors btn-press">
                    <i data-lucide="minus" class="w-8 h-8"></i>
                </button>
                <button id="btn-plus" class="w-14 h-14 flex items-center justify-center rounded-full border-2 border-slate-100 text-slate-200 hover:text-indigo-400 hover:border-indigo-200 transition-colors btn-press">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
            </div>
            <p class="text-[10px] text-slate-300 font-black mt-4 tracking-widest uppercase">Staff Only</p>
        </div>

    </div>

    <!-- 通知 -->
    <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-5 rounded-[2rem] font-black shadow-2xl opacity-0 transition-all pointer-events-none z-50 text-xl">
        受付を完了しました
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, serverTimestamp, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjSZkIuGQ4oRoMcZYLaZbdBXK45cBBXos",
            authDomain: "yakutime-for-ipad.firebaseapp.com",
            projectId: "yakutime-for-ipad",
            storageBucket: "yakutime-for-ipad.firebasestorage.app",
            messagingSenderId: "732724570588",
            appId: "1:732724570588:web:6e64cba96c6fd17646c719"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'yakutime-for-ipad';
        const urlParams = new URLSearchParams(window.location.search);
        const shopId = urlParams.get('shopId') || 'shibuya-001';

        let currentCount = 0; // 現在の値を保持

        lucide.createIcons();

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3000);
        }

        async function init() {
            await signInAnonymously(auth);
            const shopRef = doc(db, 'artifacts', appId, 'public', 'data', 'shops', shopId);
            const logColRef = collection(db, 'artifacts', appId, 'public', 'data', 'shops', shopId, 'logs');

            // リアルタイム反映
            onSnapshot(shopRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    currentCount = data.status?.waiting?.count || 0;
                    document.getElementById('display-count').innerText = currentCount;
                    document.getElementById('shop-name').innerText = `SHOP: ${data.name || shopId}`;
                }
            });

            // 受付ボタン
            document.getElementById('btn-reception').onclick = async () => {
                await updateDoc(shopRef, {
                    "status.waiting.count": increment(1),
                    "status.waiting.totalToday": increment(1)
                });
                await addDoc(logColRef, {
                    type: 'reception',
                    timestamp: serverTimestamp(),
                    completedAt: null
                });
                showToast("受付が完了しました");
            };

            // スタッフ用プラス
            document.getElementById('btn-plus').onclick = () => {
                updateDoc(shopRef, { "status.waiting.count": increment(1) });
            };

            // スタッフ用マイナス (★0以下にならないガード付き)
            document.getElementById('btn-minus').onclick = () => {
                if (currentCount > 0) {
                    updateDoc(shopRef, { "status.waiting.count": increment(-1) });
                }
            };
        }

        init();
    </script>
</body>
</html>
