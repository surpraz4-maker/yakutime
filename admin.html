<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAKUtime Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: #f8faff;
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
            border: 1px solid #edf2f7;
        }
        .btn-press:active { transform: scale(0.98); }
    </style>
</head>
<body class="p-8">

    <div class="max-w-7xl mx-auto">
        <!-- ヘッダー -->
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black text-slate-800 flex items-center gap-2">
                    YAKUtime <span class="text-indigo-600">Admin</span>
                </h1>
                <p id="shop-display-name" class="text-slate-400 font-bold mt-1">管理中: 読み込み中...</p>
            </div>
            <div class="flex gap-3">
                <button id="btn-csv" class="flex items-center gap-2 px-6 py-3 glass-card text-slate-600 font-bold btn-press hover:bg-slate-50">
                    <i data-lucide="file-text" class="w-5 h-5"></i>CSV出力
                </button>
                <button id="btn-reset-all" class="flex items-center gap-2 px-6 py-3 bg-red-50 text-red-600 rounded-2xl font-bold btn-press hover:bg-red-100 transition-colors">
                    全リセット
                </button>
            </div>
        </header>

        <!-- スタッツカード -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="glass-card p-8">
                <p class="text-slate-400 font-bold text-sm mb-2 uppercase tracking-widest">現在の待ち</p>
                <div class="flex items-baseline gap-2">
                    <span id="stat-waiting" class="text-6xl font-black text-slate-800">0</span>
                    <span class="text-xl font-bold text-slate-400">組</span>
                </div>
            </div>
            <div class="glass-card p-8">
                <p class="text-slate-400 font-bold text-sm mb-2 uppercase tracking-widest">本日の累計</p>
                <div class="flex items-baseline gap-2">
                    <span id="stat-total" class="text-6xl font-black text-slate-800">0</span>
                    <span class="text-xl font-bold text-slate-400">名</span>
                </div>
            </div>
            <div class="bg-indigo-600 rounded-[2rem] p-8 text-white shadow-xl shadow-indigo-100">
                <p class="text-indigo-200 font-bold text-sm mb-2 uppercase tracking-widest">平均待ち時間</p>
                <div class="flex items-baseline gap-2">
                    <span id="stat-avg" class="text-6xl font-black">0</span>
                    <span class="text-xl font-bold text-indigo-200">分</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- カウンター操作 -->
            <div class="space-y-6">
                <div class="glass-card p-8">
                    <h3 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2">
                        <i data-lucide="mouse-pointer-2" class="text-indigo-600"></i>カウンター操作
                    </h3>
                    <div class="space-y-4">
                        <button id="btn-plus" class="w-full py-6 bg-indigo-600 text-white rounded-2xl text-xl font-black shadow-lg shadow-indigo-200 btn-press flex items-center justify-center gap-3">
                            <i data-lucide="user-plus"></i>手動で受付
                        </button>
                        <button id="btn-minus" class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold btn-press hover:bg-slate-200">
                            1組 減らす
                        </button>
                    </div>
                </div>
            </div>

            <!-- ステータスログ -->
            <div class="lg:col-span-2">
                <div class="glass-card p-8 min-h-[400px]">
                    <h3 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2">
                        <i data-lucide="clock" class="text-indigo-600"></i>本日のステータスログ
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-slate-400 text-xs font-bold uppercase border-b border-slate-100">
                                    <th class="pb-4">受付時刻</th>
                                    <th class="pb-4">完了時刻</th>
                                    <th class="pb-4">待ち時間</th>
                                    <th class="pb-4 text-right">アクション</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body" class="text-slate-600 font-medium">
                                <!-- ログがここに挿入されます -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- モーダル（リセット確認用） -->
    <div id="modal-confirm" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white p-10 rounded-[2.5rem] max-w-sm w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-black text-slate-800 mb-4">データをリセットしますか？</h2>
            <p class="text-slate-500 mb-8 font-medium">本日の全統計データ、待ち組数、ログがすべて消去されます。この操作は取り消せません。</p>
            <div class="flex gap-4">
                <button id="btn-cancel" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold btn-press">キャンセル</button>
                <button id="btn-confirm-reset" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-bold btn-press">リセット実行</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, serverTimestamp, collection, addDoc, getDocs, query, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjSZkIuGQ4oRoMcZYLaZbdBXK45cBBXos",
            authDomain: "yakutime-for-ipad.firebaseapp.com",
            projectId: "yakutime-for-ipad",
            storageBucket: "yakutime-for-ipad.firebasestorage.app",
            messagingSenderId: "732724570588",
            appId: "1:732724570588:web:6e64cba96c6fd17646c719"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'yakutime-for-ipad';
        
        const urlParams = new URLSearchParams(window.location.search);
        const shopId = urlParams.get('shopId') || 'shibuya-001';

        lucide.createIcons();

        async function init() {
            await signInAnonymously(auth);
            const shopRef = doc(db, 'artifacts', appId, 'public', 'data', 'shops', shopId);
            const logColRef = collection(db, 'artifacts', appId, 'public', 'data', 'shops', shopId, 'logs');

            // リアルタイムリスナー
            onSnapshot(shopRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    const stats = data.status?.waiting || {};
                    document.getElementById('shop-display-name').innerText = `管理中: ${data.name || shopId}`;
                    document.getElementById('stat-waiting').innerText = stats.count || 0;
                    document.getElementById('stat-total').innerText = stats.totalToday || 0;
                    
                    // 平均時間の計算: 合計待ち時間 / 完了数
                    const totalWait = stats.totalWaitTime || 0;
                    const completed = stats.completedCount || 0;
                    const avg = completed > 0 ? Math.round(totalWait / completed) : 0;
                    document.getElementById('stat-avg').innerText = avg;
                }
            });

            // ログの表示
            onSnapshot(logColRef, (snap) => {
                const tbody = document.getElementById('log-table-body');
                tbody.innerHTML = "";
                const logs = [];
                snap.forEach(d => logs.push({id: d.id, ...d.data()}));
                
                // 新しい順に表示
                logs.sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

                logs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-50 last:border-0 hover:bg-slate-50/50 transition-colors";
                    
                    const waitTime = log.waitTime ? `${log.waitTime}分` : "-";
                    const doneTime = log.completedAt ? log.completedAt.toDate().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : "-";
                    const recTime = log.timestamp ? log.timestamp.toDate().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : "-";

                    tr.innerHTML = `
                        <td class="py-4 font-bold text-slate-800">${recTime}</td>
                        <td class="py-4 text-slate-400">${doneTime}</td>
                        <td class="py-4">
                            ${log.waitTime ? `<span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-sm font-bold">${log.waitTime}分</span>` : "-"}
                        </td>
                        <td class="py-4 text-right">
                            ${!log.completedAt ? `
                                <button onclick="completeOrder('${log.id}', ${log.timestamp?.toMillis()})" class="text-emerald-500 hover:bg-emerald-50 p-2 rounded-full transition-colors">
                                    <i data-lucide="check-circle-2"></i>
                                </button>
                            ` : `<i data-lucide="check" class="text-slate-200 inline-block p-2"></i>`}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            });

            // 操作イベント
            document.getElementById('btn-plus').onclick = () => {
                updateDoc(shopRef, { 
                    "status.waiting.count": increment(1),
                    "status.waiting.totalToday": increment(1)
                });
                addDoc(logColRef, { type: 'reception', timestamp: serverTimestamp() });
            };

            document.getElementById('btn-minus').onclick = () => {
                updateDoc(shopRef, { "status.waiting.count": increment(-1) });
            };

            // 全リセット
            document.getElementById('btn-reset-all').onclick = () => {
                document.getElementById('modal-confirm').classList.remove('hidden');
            };

            document.getElementById('btn-cancel').onclick = () => {
                document.getElementById('modal-confirm').classList.add('hidden');
            };

            document.getElementById('btn-confirm-reset').onclick = async () => {
                // 1. 店舗スタッツの初期化（ここですべての統計値を0にする）
                await updateDoc(shopRef, {
                    "status.waiting.count": 0,
                    "status.waiting.totalToday": 0,
                    "status.waiting.totalWaitTime": 0,    // 合計待ち時間をリセット
                    "status.waiting.completedCount": 0    // 完了数をリセット
                });

                // 2. ログの削除
                const querySnapshot = await getDocs(logColRef);
                const batch = writeBatch(db);
                querySnapshot.forEach((d) => {
                    batch.delete(d.ref);
                });
                await batch.commit();

                document.getElementById('modal-confirm').classList.add('hidden');
            };

            // 完了処理のグローバル化
            window.completeOrder = async (logId, startTimeMillis) => {
                const now = Date.now();
                const waitTimeMin = Math.round((now - startTimeMillis) / 60000);
                
                // ログの更新
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shops', shopId, 'logs', logId), {
                    completedAt: serverTimestamp(),
                    waitTime: waitTimeMin
                });

                // 店スタッツの更新（待ち時間を加算）
                await updateDoc(shopRef, {
                    "status.waiting.count": increment(-1),
                    "status.waiting.totalWaitTime": increment(waitTimeMin),
                    "status.waiting.completedCount": increment(1)
                });
            };
        }

        init();
    </script>
</body>
</html>
