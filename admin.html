<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAKUtime Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: #f8faff;
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
            border: 1px solid #edf2f7;
        }
        .btn-press:active { transform: scale(0.98); }
        .badge-number {
            background: #eef2ff;
            color: #4f46e5;
            padding: 2px 8px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black text-slate-800 flex items-center gap-2">
                    YAKUtime <span class="text-indigo-600">Admin</span>
                </h1>
                <p id="shop-display-name" class="text-slate-400 font-bold mt-1">管理中: 読み込み中...</p>
            </div>
            <div class="flex gap-3">
                <button id="btn-csv" class="flex items-center gap-2 px-6 py-3 glass-card text-slate-600 font-bold btn-press hover:bg-slate-50">
                    <i data-lucide="file-text" class="w-5 h-5"></i>CSV出力
                </button>
                <button id="btn-reset-all" class="flex items-center gap-2 px-6 py-3 bg-red-50 text-red-600 rounded-2xl font-bold btn-press hover:bg-red-100 transition-colors">
                    全リセット
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="glass-card p-8">
                <p class="text-slate-400 font-bold text-sm mb-2 uppercase tracking-widest">現在の待ち</p>
                <div class="flex items-baseline gap-2">
                    <span id="stat-waiting" class="text-6xl font-black text-slate-800">0</span>
                    <span class="text-xl font-bold text-slate-400">組</span>
                </div>
            </div>
            <div class="glass-card p-8">
                <p class="text-slate-400 font-bold text-sm mb-2 uppercase tracking-widest">本日の累計</p>
                <div class="flex items-baseline gap-2">
                    <span id="stat-total" class="text-6xl font-black text-slate-800">0</span>
                    <span class="text-xl font-bold text-slate-400">名</span>
                </div>
            </div>
            <div class="bg-indigo-600 rounded-[2rem] p-8 text-white shadow-xl shadow-indigo-100">
                <p class="text-indigo-200 font-bold text-sm mb-2 uppercase tracking-widest">平均待ち時間</p>
                <div class="flex items-baseline gap-2">
                    <span id="stat-avg" class="text-6xl font-black">0</span>
                    <span class="text-xl font-bold text-indigo-200">分</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Counter Controls -->
            <div class="space-y-6">
                <div class="glass-card p-8">
                    <h3 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2">
                        <i data-lucide="mouse-pointer-2" class="text-indigo-600"></i>カウンター操作
                    </h3>
                    <div class="space-y-4">
                        <button id="btn-plus" class="w-full py-6 bg-indigo-600 text-white rounded-2xl text-xl font-black shadow-lg shadow-indigo-200 btn-press flex items-center justify-center gap-3">
                            <i data-lucide="user-plus"></i>手動で受付
                        </button>
                        <button id="btn-minus" class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold btn-press hover:bg-slate-200">
                            1組 減らす (キャンセル等)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status Logs -->
            <div class="lg:col-span-2">
                <div class="glass-card p-8 min-h-[400px]">
                    <h3 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2">
                        <i data-lucide="list-ordered" class="text-indigo-600"></i>本日のステータスログ
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-slate-400 text-xs font-bold uppercase border-b border-slate-100">
                                    <th class="pb-4 px-2">受付番号</th>
                                    <th class="pb-4">受付時刻</th>
                                    <th class="pb-4">完了時刻</th>
                                    <th class="pb-4">待ち時間</th>
                                    <th class="pb-4 text-right">完了処理 / 削除</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body" class="text-slate-600 font-medium">
                                <!-- Logs injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal (Global Reset) -->
    <div id="modal-confirm" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white p-10 rounded-[2.5rem] max-w-sm w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-black text-slate-800 mb-4">データをリセットしますか？</h2>
            <p class="text-slate-500 mb-8 font-medium">本日の全統計データ、待ち組数、ログがすべて消去されます。</p>
            <div class="flex gap-4">
                <button id="btn-cancel" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold btn-press">キャンセル</button>
                <button id="btn-confirm-reset" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-bold btn-press">リセット実行</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal (Single Row) -->
    <div id="modal-delete" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white p-10 rounded-[2.5rem] max-w-sm w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-black text-slate-800 mb-4">ログを削除しますか？</h2>
            <p class="text-slate-500 mb-8 font-medium text-sm">※この操作はログの削除のみを行い、「現在の待ち組数」には影響しません。待ち人数を減らす場合は「1組減らす」ボタンを使用してください。</p>
            <div class="flex gap-4">
                <button id="btn-delete-cancel" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold btn-press">キャンセル</button>
                <button id="btn-delete-confirm" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-bold btn-press">削除する</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment, serverTimestamp, collection, addDoc, getDoc, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjSZkIuGQ4oRoMcZYLaZbdBXK45cBBXos",
            authDomain: "yakutime-for-ipad.firebaseapp.com",
            projectId: "yakutime-for-ipad",
            storageBucket: "yakutime-for-ipad.firebasestorage.app",
            messagingSenderId: "732724570588",
            appId: "1:732724570588:web:6e64cba96c6fd17646c719"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'yakutime-for-ipad';
        
        const urlParams = new URLSearchParams(window.location.search);
        const shopId = urlParams.get('shopId') || 'shibuya-001';

        lucide.createIcons();

        async function init() {
            await signInAnonymously(auth);
            const shopRef = doc(db, 'artifacts', appId, 'public', 'data', 'shops', shopId);
            const logColRef = collection(db, 'artifacts', appId, 'public', 'data', 'shops', shopId, 'logs');

            let currentCount = 0;
            let currentLogs = [];
            let deleteId = null;

            // Stats Listener
            onSnapshot(shopRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    const stats = data.status?.waiting || {};
                    currentCount = stats.count || 0;
                    document.getElementById('shop-display-name').innerText = `管理中: ${data.name || shopId}`;
                    document.getElementById('stat-waiting').innerText = currentCount;
                    document.getElementById('stat-total').innerText = stats.totalToday || 0;
                    
                    const totalWait = stats.totalWaitTime || 0;
                    const completed = stats.completedCount || 0;
                    const avg = completed > 0 ? Math.round(totalWait / completed) : 0;
                    document.getElementById('stat-avg').innerText = avg;
                }
            });

            // Logs Listener
            onSnapshot(logColRef, (snap) => {
                const tbody = document.getElementById('log-table-body');
                tbody.innerHTML = "";
                currentLogs = [];
                snap.forEach(d => currentLogs.push({id: d.id, ...d.data()}));
                
                currentLogs.sort((a,b) => (b.number || 0) - (a.number || 0));

                currentLogs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-50 last:border-0 hover:bg-slate-50/50 transition-colors";
                    
                    const doneTime = log.completedAt ? log.completedAt.toDate().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : "-";
                    const recTime = log.timestamp ? log.timestamp.toDate().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : "-";
                    const numberLabel = log.number ? `<span class="badge-number">${log.number}</span>` : "-";

                    tr.innerHTML = `
                        <td class="py-4 px-2">${numberLabel}</td>
                        <td class="py-4 font-bold text-slate-800">${recTime}</td>
                        <td class="py-4 text-slate-400">${doneTime}</td>
                        <td class="py-4">
                            ${log.waitTime ? `<span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-sm font-bold">${log.waitTime}分</span>` : "-"}
                        </td>
                        <td class="py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                ${!log.completedAt ? `
                                    <button onclick="completeOrder('${log.id}', ${log.timestamp?.toMillis()})" class="bg-emerald-50 text-emerald-600 px-4 py-2 rounded-xl text-sm font-black btn-press hover:bg-emerald-100 transition-colors flex items-center gap-2">
                                        <i data-lucide="check" class="w-4 h-4"></i>完了
                                    </button>
                                ` : `<span class="text-slate-300 text-xs font-bold uppercase italic px-4">完了済み</span>`}
                                
                                <button onclick="openDeleteModal('${log.id}')" class="text-slate-300 hover:text-red-500 p-2 transition-colors">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            });

            // Handlers
            document.getElementById('btn-plus').onclick = async () => {
                const snap = await getDoc(shopRef);
                const nextNumber = (snap.data().status?.waiting?.totalToday || 0) + 1;
                await updateDoc(shopRef, { 
                    "status.waiting.count": increment(1),
                    "status.waiting.totalToday": increment(1)
                });
                await addDoc(logColRef, { 
                    number: nextNumber, 
                    timestamp: serverTimestamp() 
                });
            };

            document.getElementById('btn-minus').onclick = () => {
                if (currentCount > 0) {
                    updateDoc(shopRef, { "status.waiting.count": increment(-1) });
                }
            };

            // Individual Delete
            window.openDeleteModal = (id) => {
                deleteId = id;
                document.getElementById('modal-delete').classList.remove('hidden');
            };
            document.getElementById('btn-delete-cancel').onclick = () => {
                document.getElementById('modal-delete').classList.add('hidden');
                deleteId = null;
            };
            document.getElementById('btn-delete-confirm').onclick = async () => {
                if (deleteId) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shops', shopId, 'logs', deleteId));
                    document.getElementById('modal-delete').classList.add('hidden');
                    deleteId = null;
                }
            };

            // Global Reset
            document.getElementById('btn-reset-all').onclick = () => document.getElementById('modal-confirm').classList.remove('hidden');
            document.getElementById('btn-cancel').onclick = () => document.getElementById('modal-confirm').classList.add('hidden');
            document.getElementById('btn-confirm-reset').onclick = async () => {
                await updateDoc(shopRef, {
                    "status.waiting.count": 0,
                    "status.waiting.totalToday": 0,
                    "status.waiting.totalWaitTime": 0,
                    "status.waiting.completedCount": 0
                });
                const querySnapshot = await getDocs(logColRef);
                const batch = writeBatch(db);
                querySnapshot.forEach((d) => batch.delete(d.ref));
                await batch.commit();
                document.getElementById('modal-confirm').classList.add('hidden');
            };

            // Order Completion
            window.completeOrder = async (logId, startTimeMillis) => {
                const now = Date.now();
                const waitTimeMin = startTimeMillis ? Math.max(0, Math.round((now - startTimeMillis) / 60000)) : 0;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shops', shopId, 'logs', logId), {
                    completedAt: serverTimestamp(),
                    waitTime: waitTimeMin
                });
                await updateDoc(shopRef, {
                    "status.waiting.count": currentCount > 0 ? increment(-1) : 0,
                    "status.waiting.totalWaitTime": increment(waitTimeMin),
                    "status.waiting.completedCount": increment(1)
                });
            };

            // CSV Export
            document.getElementById('btn-csv').onclick = () => {
                if (currentLogs.length === 0) return;
                const headers = ["受付番号", "受付時刻", "完了時刻", "待ち時間(分)"];
                const rows = currentLogs.map(log => [
                    log.number || "-",
                    log.timestamp ? log.timestamp.toDate().toLocaleString('ja-JP') : "-",
                    log.completedAt ? log.completedAt.toDate().toLocaleString('ja-JP') : "-",
                    log.waitTime || "0"
                ]);
                let csvContent = "\uFEFF" + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `logs_${shopId}.csv`;
                link.click();
            };
        }

        init();
    </script>
</body>
</html>
